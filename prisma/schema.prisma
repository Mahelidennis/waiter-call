// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  // directUrl = env("DIRECT_URL") // Temporarily commented out
}

// Restaurant model - represents a restaurant using the system
model Restaurant {
  id            String       @id @default(uuid())
  name          String
  slug          String       @unique // For URL routing (e.g., /r/restaurant-slug)
  email         String       @unique
  phone         String?
  address       String?
  logoUrl       String?
  menuUrl       String?      // External menu URL for customers
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  
  // Relations
  tables        Table[]
  waiters       Waiter[]
  promotions    Promotion[]
  subscriptions Subscription[]
  calls         Call[]
  pushSubscriptions PushSubscription[]
  
  @@index([slug])
}

// Table model - represents a physical table in the restaurant
model Table {
  id            String       @id @default(uuid())
  restaurantId String
  number        String       // Table number/identifier (e.g., "T1", "Table 5")
  qrCode        String       @unique // Unique identifier for QR code
  isActive      Boolean      @default(true)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  
  // Relations
  restaurant    Restaurant   @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  calls         Call[]
  assignedWaiters WaiterTable[]
  
  @@unique([restaurantId, number])
  @@index([qrCode])
  @@index([restaurantId])
}

// Waiter model - represents a waiter/staff member
model Waiter {
  id            String       @id @default(uuid())
  restaurantId String
  name          String
  email         String?
  phone         String?
  accessCodeHash String?     // Hashed 6-digit access code for PIN-based authentication
  isActive      Boolean      @default(true)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  
  // Relations
  restaurant    Restaurant   @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  calls         Call[]
  assignedTables WaiterTable[]
  pushSubscriptions PushSubscription[]
  
  @@index([restaurantId])
}

// Many-to-many relationship between Waiters and Tables
model WaiterTable {
  id        String   @id @default(uuid())
  waiterId  String
  tableId   String
  createdAt DateTime @default(now())
  
  waiter    Waiter   @relation(fields: [waiterId], references: [id], onDelete: Cascade)
  table     Table    @relation(fields: [tableId], references: [id], onDelete: Cascade)
  
  @@unique([waiterId, tableId])
  @@index([waiterId])
  @@index([tableId])
}

// Call model - represents a customer's call for a waiter
model Call {
  id            String       @id @default(uuid())
  restaurantId  String
  tableId       String
  waiterId      String?      // Assigned waiter (can be null if auto-assigned)
  status        CallStatus   @default(PENDING)
  requestedAt   DateTime     @default(now())
  
  // Enhanced lifecycle timestamps
  acknowledgedAt DateTime?    // When waiter acknowledged the call
  completedAt    DateTime?    // When service was completed
  missedAt       DateTime?    // When call was marked as missed
  timeoutAt      DateTime?    // When call will timeout (SLA)
  
  // Legacy fields for backward compatibility
  handledAt      DateTime?    // @deprecated Use completedAt instead
  responseTime   Int?         // Response time in milliseconds (more precise)
  
  // Relations
  restaurant    Restaurant   @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  table         Table        @relation(fields: [tableId], references: [id], onDelete: Cascade)
  waiter        Waiter?      @relation(fields: [waiterId], references: [id], onDelete: SetNull)
  
  @@index([restaurantId])
  @@index([tableId])
  @@index([waiterId])
  @@index([status])
  @@index([requestedAt])
  @@index([timeoutAt]) // For timeout detection
  @@index([missedAt])   // For missed call analytics
}

enum CallStatus {
  PENDING       // Customer called, waiting for waiter
  ACKNOWLEDGED  // Waiter accepted the call
  IN_PROGRESS   // Waiter is on the way to table
  COMPLETED     // Service delivered successfully
  MISSED        // Timeout elapsed with no acknowledgment
  CANCELLED     // Customer cancelled the call
  HANDLED       // @deprecated Use COMPLETED instead
}

// Promotion model - represents ads/promotions shown to customers
model Promotion {
  id            String       @id @default(uuid())
  restaurantId  String
  title         String
  description   String?
  imageUrl      String?
  linkUrl       String?
  isActive      Boolean      @default(true)
  startDate     DateTime?
  endDate       DateTime?
  displayOrder  Int          @default(0)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  
  // Relations
  restaurant    Restaurant   @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  
  @@index([restaurantId])
  @@index([isActive])
}

// Subscription model - tracks restaurant subscriptions
model Subscription {
  id                String            @id @default(uuid())
  restaurantId      String            @unique
  stripeCustomerId  String?          @unique
  stripeSubscriptionId String?       @unique
  status            SubscriptionStatus @default(TRIAL)
  plan              String            @default("basic") // basic, premium, etc.
  currentPeriodEnd  DateTime?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  
  // Relations
  restaurant        Restaurant        @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  
  @@index([restaurantId])
  @@index([status])
}

enum SubscriptionStatus {
  TRIAL
  ACTIVE
  CANCELLED
  PAST_DUE
}

// Push Subscription model - tracks waiter device push subscriptions
model PushSubscription {
  id            String   @id @default(uuid())
  waiterId      String
  restaurantId  String
  endpoint      String   // Push service endpoint URL
  p256dh        String   // VAPID public key
  auth          String   // VAPID auth secret
  userAgent     String?  // Device/user agent for debugging
  createdAt     DateTime @default(now())
  lastUsedAt    DateTime @default(now())
  
  // Relations
  waiter        Waiter   @relation(fields: [waiterId], references: [id], onDelete: Cascade)
  restaurant    Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  
  // Indexes for performance
  @@index([waiterId])
  @@index([restaurantId])
  @@index([createdAt])
  @@index([lastUsedAt])
  // Unique constraint to prevent duplicate subscriptions for same waiter+endpoint
  @@unique([waiterId, endpoint])
}
